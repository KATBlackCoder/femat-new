---
import Layout from '../../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import OptimizedImage from '../../../components/OptimizedImage.astro';
import { useTranslations } from '../../../lib/i18n/translations';

export async function getStaticPaths() {
  const evenements = await getCollection('evenements', ({ data }) => data.lang === 'en');
  return evenements.map((event) => ({
    params: { slug: event.id },
    props: { event },
  }));
}

const { event } = Astro.props;
const { Content, headings } = await event.render();
const t = useTranslations('en');

const formatDate = (date: Date, endDate?: Date) => {
  if (endDate) {
    return `${date.toLocaleDateString('en-US', {
      day: 'numeric',
      month: 'long',
      year: 'numeric'
    })} - ${endDate.toLocaleDateString('en-US', {
      day: 'numeric',
      month: 'long',
      year: 'numeric'
    })}`;
  }
  return date.toLocaleDateString('en-US', {
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  });
};

const getStatusColor = (status: string) => {
  switch (status) {
    case 'upcoming': return 'secondary';
    case 'ongoing': return 'default';
    case 'completed': return 'outline';
    default: return 'secondary';
  }
};

const getStatusText = (status: string) => {
  switch (status) {
    case 'upcoming': return t('events.upcoming');
    case 'ongoing': return t('events.ongoing');
    case 'completed': return t('events.completed');
    default: return status;
  }
};

const getStatusClass = (status: string) => {
  switch (status) {
    case 'upcoming': return 'border-blue-500 bg-blue-50 dark:bg-blue-950';
    case 'ongoing': return 'border-green-500 bg-green-50 dark:bg-green-950';
    case 'completed': return 'border-gray-400 bg-gray-50 dark:bg-gray-900';
    default: return 'border-gray-300';
  }
};

const getTypeLabel = (type: string) => {
  const labels: Record<string, string> = {
    'competition': t('events.type.competition'),
    'formation': t('events.type.formation'),
    'passage-grades': t('events.type.passage-grades'),
    'stage': t('events.type.stage'),
    'conference': t('events.type.conference'),
    'autre': t('events.type.autre')
  };
  return labels[type] || type;
};

const site = Astro.site?.toString().replace(/\/$/, '') ?? '';
const eventUrl = `${site}${Astro.url.pathname}`;
const eventJsonLd = {
  '@context': 'https://schema.org',
  '@type': 'Event',
  name: event.data.title,
  description: event.data.description,
  startDate: event.data.date.toISOString(),
  ...(event.data.endDate && { endDate: event.data.endDate.toISOString() }),
  location: { '@type': 'Place', name: event.data.location },
  ...(event.data.image && { image: event.data.image.startsWith('http') ? event.data.image : `${site}${event.data.image.startsWith('/') ? event.data.image : `/${event.data.image}`}` }),
  organizer: { '@id': `${site}/#organization` },
};
const breadcrumbJsonLd = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    { '@type': 'ListItem', position: 1, name: 'Home', item: `${site}/en` },
    { '@type': 'ListItem', position: 2, name: 'Events', item: `${site}/en/evenements` },
    { '@type': 'ListItem', position: 3, name: event.data.title, item: eventUrl },
  ],
};
---

<Layout
  title={`${event.data.title} - FEMAT`}
  description={event.data.description}
  lang="en"
  jsonLd={[eventJsonLd, breadcrumbJsonLd]}
>
  <article class="container mx-auto px-4 py-8 max-w-4xl">
    <header class={`mb-8 p-6 rounded-lg border-2 ${getStatusClass(event.data.status)}`}>
      <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4 mb-4">
        <div class="flex items-center gap-2">
          <Badge variant={getStatusColor(event.data.status)}>
            {getStatusText(event.data.status)}
          </Badge>
          <Badge variant="outline">{getTypeLabel(event.data.type)}</Badge>
        </div>
      </div>

      <h1 class="text-4xl font-bold mb-4">{event.data.title}</h1>

      {event.data.description && (
        <p class="text-xl mb-6">{event.data.description}</p>
      )}

      <div class="grid md:grid-cols-2 gap-4 text-sm">
        <div class="flex items-center gap-2">
          <span class="font-semibold">ğŸ“… {t('events.date')}:</span>
          <span>{formatDate(event.data.date, event.data.endDate)}</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="font-semibold">ğŸ“ {t('events.location')}:</span>
          <span>{event.data.location}</span>
        </div>
        {event.data.capacity && (
          <div class="flex items-center gap-2">
            <span class="font-semibold">ğŸ‘¥ {t('events.capacity')}:</span>
            <span>{event.data.registered || 0} / {event.data.capacity}</span>
          </div>
        )}
        {event.data.price && (
          <div class="flex items-center gap-2">
            <span class="font-semibold">ğŸ’° {t('events.price')}:</span>
            <span>{event.data.price}</span>
          </div>
        )}
      </div>
    </header>

    {event.data.image && (
      <OptimizedImage
        src={event.data.image}
        alt={event.data.title}
        width={1200}
        height={630}
        loading="eager"
        class="rounded-lg mb-8"
      />
    )}

    <div class="prose prose-lg max-w-none dark:prose-invert">
      <Content />
    </div>

    <div class="flex justify-center mt-8">
      <Button variant="outline" asChild>
        <a href="/en/evenements">{t('events.backToEvents')}</a>
      </Button>
    </div>
  </article>
</Layout>
