---
import Layout from '../../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Separator } from '@/components/ui/separator';
import OptimizedImage from '../../../components/OptimizedImage.astro';

export async function getStaticPaths() {
  const actualites = await getCollection('actualites', ({ data }) => data.lang === 'ru');
  return actualites.map((article) => ({
    params: { slug: article.id },
    props: { article },
  }));
}

const { article } = Astro.props;
const { Content, headings } = await article.render();

const site = Astro.site?.toString().replace(/\/$/, '') ?? '';
const articleUrl = `${site}${Astro.url.pathname}`;
const articleJsonLd = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: article.data.title,
  description: article.data.description,
  datePublished: article.data.date.toISOString().split('T')[0],
  ...(article.data.author && { author: { '@type': 'Person', name: article.data.author } }),
  ...(article.data.image && { image: article.data.image.startsWith('http') ? article.data.image : `${site}${article.data.image.startsWith('/') ? article.data.image : `/${article.data.image}`}` }),
  publisher: { '@id': `${site}/#organization` },
  mainEntityOfPage: articleUrl,
};
const breadcrumbJsonLd = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    { '@type': 'ListItem', position: 1, name: 'Главная', item: `${site}/ru` },
    { '@type': 'ListItem', position: 2, name: 'Новости', item: `${site}/ru/actualites` },
    { '@type': 'ListItem', position: 3, name: article.data.title, item: articleUrl },
  ],
};
---

<Layout
  title={`${article.data.title} - FEMAT`}
  description={article.data.description}
  lang="ru"
  jsonLd={[articleJsonLd, breadcrumbJsonLd]}
>
  <article class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Заголовок статьи -->
    <header class="mb-8">
      <div class="flex items-center gap-2 mb-4">
        <span class="text-sm text-muted-foreground">
          {article.data.date.toLocaleDateString('ru-RU', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          })}
        </span>
        {article.data.author && (
          <>
            <span class="text-muted-foreground/70">•</span>
            <span class="text-sm text-muted-foreground">{article.data.author}</span>
          </>
        )}
      </div>

      <h1 class="text-4xl font-bold mb-4">{article.data.title}</h1>

      {article.data.description && (
        <p class="text-xl text-muted-foreground mb-6">{article.data.description}</p>
      )}

      {article.data.image && (
        <OptimizedImage
          src={article.data.image}
          alt={article.data.title}
          width={1200}
          height={630}
          loading="eager"
          class="rounded-lg mb-6"
        />
      )}

      {article.data.tags && article.data.tags.length > 0 && (
        <div class="flex flex-wrap gap-2 mb-4">
          {article.data.tags.map((tag) => (
            <Badge variant="secondary">{tag}</Badge>
          ))}
        </div>
      )}
    </header>

    <Separator class="my-8" />

    <!-- Содержание статьи -->
    <div class="prose prose-lg max-w-none dark:prose-invert">
      <Content />
    </div>

    <Separator class="my-8" />

    <!-- Кнопка возврата -->
    <div class="flex justify-center mt-8">
      <Button variant="outline" asChild>
        <a href="/ru/actualites">← Вернуться к новостям</a>
      </Button>
    </div>
  </article>
</Layout>
